{% extends "bookmarks/base.html" %}

{% block content %}
{% partial list-partial %}
{% endblock content %}

{% partialdef list-partial %}
{% if htmx %}
    <title>Bookmarks - HTMX</title>
    {% include "sidebar.html#nav-mobile-partial" %}
    {% include "sidebar.html#nav-desktop-partial" %}
    {% include "bookmarks/base.html#menu-partial" %}
{% endif %}

<div class="flex justify-end mb-4 mt-0 gap-4">
    <div x-data="{search: false}"
        x-on:keydown.meta.K.window="search = true">
        <label class="input w-64">
            <svg class="h-[2em] opacity-50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <g
                  stroke-linejoin="round"
                  stroke-linecap="round"
                  stroke-width="2.5"
                  fill="none"
                  stroke="currentColor"
                >
                  <circle cx="11" cy="11" r="8"></circle>
                  <path d="m21 21-4.3-4.3"></path>
                </g>
            </svg>
        <input type="search"
            name="q"
            id="search"
            placeholder="Search"
            {# fake pagination to force list-items-partial to be returned #}
            hx-get="{% url 'bookmarks:list' %}?page=x"
            hx-trigger="keyup changed delay:0.5s"
            hx-target="#id_bookmarks"
            class="grow"
            x-on:keyup.esc.prevent.stop="$el.blur(); search = false"
            x-on:blur="$el.value = ''; search = false"
            x-trap="search" />
            <kbd class="hidden md:inline kbd kbd-sm">âŒ˜</kbd>
            <kbd class="hidden md:inline kbd kbd-sm">K</kbd>
        </label>
    </div>

    <div class="flex md:mt-0">
        <button hx-get="{% url 'bookmarks:new' %}"
            type="button"
            hx-trigger="click"
            hx-target="#id_content"
            hx-push-url="true"
            class="btn btn-primary hidden md:inline-flex">
            New Bookmark
        </button>
        <button hx-get="{% url 'bookmarks:new' %}"
            type="button"
            hx-trigger="click"
            hx-target="#id_content"
            hx-push-url="true"
            class="btn btn-primary md:hidden">
            New
        </button>
    </div>
</div>

<ul id="id_bookmarks" class="list bg-base-100 border-base-300 rounded-box">
    {% partial list-items-partial %}
</ul>
{% endpartialdef list-partial %}

{% partialdef list-items-partial %}
{% for bookmark in page_obj %}
    <li class="list-row"
        {% if forloop.last and page_obj.has_next %}
            hx-get="{% querystring page=page_obj.next_page_number %}"
            hx-trigger="revealed"
            hx-swap="afterend"
        {% endif %}>
        <article>
            <h2 class="text-primary font-medium text-base mb-2">
                <a href="{{ bookmark.url }}" target="_blank" rel="noreferrer" class="link link-hover">{{ bookmark.title }}</a>
                {% if not bookmark.active %}
                    <span class="badge badge-error badge-sm">(inactive)</span>
                {% endif %}
            </h2>
            <p class="text-sm text-base-content mb-3">
                {{ bookmark.description }}
            </p>
            <ul class="flex flex-wrap gap-2 mb-1">
                {% for tag in bookmark.tags.all %}
                    <li class="inline">
                        <a href="?tags={{ tag }}" hx-get="?tags={{ tag }}" hx-target="#id_content" class="link-hover text-secondary text-sm">{{ tag }}</a>
                    </li>
                {% endfor %}
            </ul>
            <div class="text-xs text-base-content/50">
                {{ bookmark.created|date:'F Y'|lower }}
                <a hx-get="{% url 'bookmarks:edit' bookmark.id %}"
                    href="{% url 'bookmarks:edit' bookmark.id %}"
                    class="link-hover text-base-content/50 ml-2">
                    edit
                </a>
            </div>
        </article>
    </li>
{% endfor %}
{% endpartialdef list-items-partial %}
