{% extends "upkeep/base.html" %}

{% block title %}{{ task.name|truncatewords:2 }}{% endblock %}

{% partialdef field-partial %}
<div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
    <dt class="text-sm font-medium text-base-content">{{ label }}</dt>
    <dd class="mt-1 text-sm text-base-content/70 sm:col-span-2 sm:mt-0">{{ value }}</dd>
</div>
{% endpartialdef field-partial %}

{% partialdef detail-partial %}
{% if htmx %}
    <title>{{ task.name|truncatewords:2 }} - HTMX</title>
    {% include "sidebar.html#nav-mobile-partial" %}
    {% include "sidebar.html#nav-desktop-partial" %}
    {% include "upkeep/base.html#menu-partial" %}
{% endif %}

<div class="pb-4 card bg-base-100 border border-base-300 rounded-box">

    {# Header #}
    <div class="flex justify-between px-4 py-6 sm:px-6">
        <div>
            <h3 class="text-base font-semibold text-base-content">
                <a href="{% url 'upkeep:area-detail' task.area_id %}"
                    hx-get="{% url 'upkeep:area-detail' task.area_id %}"
                    hx-push-url="true"
                    hx-target="#id_content"
                    class="link link-hover link-primary">{{ task.area.name }}</a> : {{ task.name }}</h3>
            <p class="mt-1 max-w-2xl text-sm text-base-content/70">{{ task.notes }}</p>
            {% if task.interval %}
                <p class="mt-1 max-w-2xl text-sm text-base-content/70">Interval: {{ task.interval }} {{ task.frequency }} </p>
            {% endif %}
            {% if task.duration %}
                <p class="mt-1 max-w-2xl text-sm text-base-content/70">Duration: {{ task.duration }}</p>
            {% endif %}
        </div>
        {# Manage Menu #}
        <details class="dropdown dropdown-end">
            <summary class="btn btn-ghost btn-sm">Manage</summary>
            <ul class="menu dropdown-content z-10 mt-2 w-56 rounded-box bg-base-100 p-2 shadow">
                <li>
                    <a href="{% url 'upkeep:task-edit' task.id %}"
                        hx-get="{% url 'upkeep:task-edit' task.id %}"
                        hx-push-url="true"
                        hx-target="#id_content">Edit task</a>
                </li>
                <li>
                    <a href="#"
                        hx-post="{% url 'upkeep:task-delete' task.id %}"
                        hx-confirm="Are you sure you want to delete this item?"
                        hx-params="none"
                        hx-target="#id_content">Delete task</a>
                </li>
                <li>
                    <a href="{% url 'upkeep:schedule-new' task.id %}"
                        hx-get="{% url 'upkeep:schedule-new' task.id %}"
                        hx-push-url="true"
                        hx-target="#id_content">Create schedule</a>
                </li>
                <li>
                    <a href="{% url 'upkeep:task-item-new' task.id %}"
                        hx-get="{% url 'upkeep:task-item-new' task.id %}"
                        hx-push-url="true"
                        hx-target="#id_content">Add item</a>
                </li>
            </ul>
        </details>
    </div>

    {# Schedule table #}
    <div class="overflow-x-auto px-4 sm:px-6 lg:px-8">
        <table class="table table-sm w-full">
            <thead>
                <tr>
                    <th scope="col" class="text-sm font-semibold text-base-content">Completed</th>
                    <th scope="col" class="text-sm font-semibold text-base-content">Due Date</th>
                    <th scope="col" class="text-sm font-semibold text-base-content">Date Completed</th>
                    <th scope="col" class="hidden md:table-cell text-sm font-semibold text-base-content">Notes</th>
                    <th scope="col" class="hidden md:table-cell text-sm font-semibold text-base-content"></th>
                </tr>
            </thead>
            <tbody>
                {% for schedule in task.schedules.all %}
                <tr class="group">
                    <td class="text-sm font-medium text-base-content">
                        <input
                            hx-patch="{% url 'upkeep:schedule-toggle' schedule.id %}"
                            type="checkbox"
                            class="checkbox checkbox-sm checkbox-primary"
                            {% if schedule.is_complete %}checked{% endif %} >
                    </td>
                    <td class="text-sm text-base-content/70">{{ schedule.due_date }}</td>
                    <td class="text-sm text-base-content/70">{{ schedule.completion_date|default:'' }}</td>
                    <td class="hidden md:table-cell text-sm text-base-content/70">{{ schedule.notes }}</td>
                    <td class="hidden md:table-cell text-right">
                        <button hx-get="{% url 'upkeep:schedule-edit' schedule.id %}"
                            hx-target="#id_content"
                            hx-push-url="true"
                            type="button"
                            class="btn btn-ghost btn-xs">edit</button>

                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td class="text-sm text-base-content/70" colspan="5">No schedules</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# Consumable table #}
    <div class="overflow-x-auto px-4 sm:px-6 lg:px-8">
        <table class="table table-sm w-full">
            <thead>
                <tr>
                    <th scope="col" class="text-sm font-semibold text-base-content">Consumable</th>
                    <th scope="col" class="hidden sm:table-cell text-sm font-semibold text-base-content text-center">Required</th>
                    <th scope="col" class="text-sm font-semibold text-base-content text-center">On Hand</th>
                    <th scope="col" class="hidden md:table-cell text-sm font-semibold text-base-content">Notes</th>
                    <th scope="col" class="hidden md:table-cell text-sm font-semibold text-base-content"></th>
                </tr>
            </thead>
            <tbody>
                {% for tc in task_consumables %}
                <tr class="group">
                    <td class="text-sm text-base-content">
                        <a hx-get="{% url 'stuff:item-detail' tc.item.pk %}"
                            hx-target="#id_content"
                            hx-push-url="true"
                            href="#"
                            class="link link-hover link-primary" >
                            {{ tc.item.name }}
                        </a>
                    </td>
                    <td class="hidden sm:table-cell text-sm text-base-content/70 text-center">{{ tc.quantity }}</td>
                    <td class="text-sm text-base-content/70 text-center">{{ tc.item.quantity }}</td>
                    <td class="hidden md:table-cell text-sm text-base-content/70">{{ tc.item.notes }}</td>
                    <td class="hidden md:table-cell text-right">
                        <button hx-get="{% url 'upkeep:task-item-edit' tc.id %}"
                            hx-target="#id_content"
                            hx-push-url="true"
                            type="button"
                            class="btn btn-ghost btn-xs">edit</button>
                    </td>

                </tr>
                {% empty %}
                <tr>
                    <td class="text-sm text-base-content/70" colspan="5">No consumables</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endpartialdef detail-partial %}

{% block content %}
  {% partial detail-partial %}
{% endblock content %}
